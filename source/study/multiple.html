<link rel="stylesheet" href="./study.css" />
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="./study.js"></script>

<!-- eruda debug -->
<!-- <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script> -->

<!-- <script src="http://192.168.1.9:8080/target/target-script-min.js#anonymous"></script> -->

<div :class="'app ' + (isMobile ? 'mobile' : '')" id="app">
    <div class="user-info f13">
        ÂΩìÂâçÁî®Êà∑: <span class="name">${ currentUser || 'ÈªòËÆ§Áî®Êà∑' }</span>
    </div>
    <h1 style="margin-bottom: 0">ËØçËØ≠ËÆ§ËØª</h1>
    <div class="font-bar mt-10 mb-20" :class="isMobile ? 'ta-l' : 'ta-r'">
        
        <button :class="fontType === 1 ? 'primary' : ''" @click="fontType = 1">Â≠ó‰Ωì1</button>
        <button :class="fontType === 2 ? 'primary' : ''" @click="fontType = 2">Â≠ó‰Ωì2</button>
        <button :class="fontType === 3 ? 'primary' : ''" @click="fontType = 3">Â≠ó‰Ωì3</button>
        <button :class="fontType === 4 ? 'primary' : ''" @click="fontType = 4">Â≠ó‰Ωì4</button>
        <button :class="fontType === 5 ? 'primary' : ''" @click="fontType = 5">Â≠ó‰Ωì5</button>
        <div class="option-bar dis-ib" :class="{'mt-10': isMobile}">
            <!-- <label>
                title: <input  class="f13" style="width: 150px" v-model="title" > <button class="filter-btn" @click="filterByTitle">ËøáÊª§</button>
            </label> -->
            <label>
                <span>title:</span> 
                <select  class="f13 title-select" v-model="title" >
                    <option value="">ÂÖ®ÈÉ®</option>
                    <option v-for="(ttl, i) in titleList" :value="ttl" :key="i">${ttl}</option>
                </select>
                <button class="filter-btn" @click="filterByTitle">ËøáÊª§</button>
            </label>
            <label>
                <input type="checkbox" class="va-m" v-model="isRandom" @change="changeRandom"></checkbox>
                <span class="f13 va-m">ÊòØÂê¶ÈöèÊú∫</span>
            </label>
        </div>
    </div>
    <section class="app-main multiple-container" :class="{'testing': isTestMode}">
        <div class="single m-auto">
            <h5 class="f20 blue ta-c" :style="isMobile ? '' : 'margin: 0px;'">${wordList[activeIndex]?.title || ''}</h5>
            <div class="card-list-wrap pos-r">
                <button class="prev" @click="showPrev">&lt;</button>
                <button class="next" @click="showNext">&gt;</button>
                <ul class="card-list flex-row justify-center pos-r">
                    <li v-for="(item, index) in wordList" :key="index" class="card-item-wrap">
                        <transition :name="isNext ? 'lfade' : 'rfade'">
                            <div class="card-item" v-show="index === activeIndex" :class="{'view-answer': index === activeIndex && isViewAnswer}" @click="handleClickCard(index)">
                                <div :class="'card-con flex1 font' + fontType" :style="fontStyle">
                                    <span class="chr pos-r dis-ib" v-for="(chr, i) in item.word.split('')" :key="i">
                                        ${chr}
                                    </span>
                                </div>
                            </div>
                        </transition>
                        
                    </li>
                </ul>
            </div>
            <p class="mt-30 ta-c">
                <i class="num f30">${activeIndex + 1} / ${wordList.length}</i>

            </p>
        </div>
    </section>
</div>

<script>
    const searchParams = new URLSearchParams(location.search)
    const isTest = ![null, '0', 'false'].includes(searchParams.get('test'))
    const cacheWordTitle = LCache.get('mwordTitle') || '';
    const cacheWordList = LCache.get('mwords') || [];
    const titleList = [...new Set(cacheWordList.map(item => item.title).filter(v => v && !!v.trim()))]

    window.myapp = new Vue({
        el: "#app",
        delimiters: ["${", "}"],
        data: {
            currentUser: getCurUser(),
            activeIndex: 0,
            isMobile: getIsMobile(),
            isNext: true,
            isTestMode: isTest,
            isViewAnswer: false,
            isRandom: false,
            showCard: true,
            fontType: isTest ? 5 : LCache.get('fontType') || 5,
            newWord: "",
            wordList: cacheWordTitle ? cacheWordList.filter(item => item.title === cacheWordTitle) : cacheWordList,
            title: cacheWordTitle,
            titleList,
        },
        
        watch: {
            fontType() {
                LCache.set('fontType', this.fontType)
            },
        },
        computed: {
            fontStyle: function() {
                // word: {date, word}
                const word = this.wordList[this.activeIndex]
                if (!word) {
                    return {fontSize: '250px'}
                }
                const sizeMap = {
                    1: 330,
                    2: 330,
                    3: 330,
                    4: 250,
                    5: 200,
                    6: 160,
                    7: 130,
                }

                const mobileSizeMap = {
                    1: 180,
                    2: 120,
                    3: 90,
                    4: 120,
                    5: 60,
                    6: 90,
                    7: 90,
                }

                const map = this.isMobile ? mobileSizeMap : sizeMap
                const size = map[word.word.length] || 50
                return { fontSize: size + 'px'}
            }
        },
        methods: {
            
            filterByTitle() {
                const ttl = this.title.trim()
                console.log("üöÄ ~ filterByTitle ~ ttl:", ttl)
                LCache.set('mwordTitle', ttl);
                if (!ttl) {
                    this.wordList = this.orderedWordList.slice()
                } else {
                    this.wordList = this.orderedWordList.filter(item => item.title === ttl);
                }
            },
            changeRandom(event) {
                if (this.isRandom) {
                    this.wordList = getShuffleList(this.wordList)
                } else {
                    this.wordList = this.orderedWordList;
                }
            },
            handleClickCard(index) {
                if (!index === this.activeIndex) return
                this.isViewAnswer = !this.isViewAnswer
            },
            showNext() {
                this.isNext = true
                if (this.activeIndex < this.wordList.length - 1) {
                    this.activeIndex++;
                } else {
                    this.activeIndex = 0;
                }
            },
            showPrev() {
                this.isNext = false
                if (this.activeIndex > 0) {
                    this.activeIndex--;
                } else {
                    this.activeIndex = this.wordList.length - 1;
                }
            },
        },
        mounted() {
            // showToast(window.innerWidth + ', ' + document.documentElement.clientWidth)
            if (!this.wordList.length) {
                showToast('ËØ∑ÂÖàÂ¢ûÂä†ËØçËØ≠')
                location.href = '/study'
            } else {
                this.orderedWordList = cacheWordList.slice()
            }
        }
    });
</script>
