---
title: å¦‚ä½•è§£å†³TS2322æŠ¥é”™
date: 2024-03-13 22:59:47
tags: Typescript
categories: Typescript
---

> åŸæ–‡åœ°å€[å¦‚ä½•è§£å†³ TS2322: "could be instantiated with a different subtype of constraint" - æ˜é‡‘](https://juejin.cn/post/7012186304767066148#SnippetTab)

å¦‚ä½•è§£å†³ TS2322 æŠ¥é”™: "could be instantiated with a different subtype of constraint"

## é‡åˆ°é—®é¢˜

æœ€è¿‘ä½¿ç”¨ ts å†™ä¸ªå·¥å…·ç±»å‡½æ•°æ—¶, é‡åˆ°äº† ts æŠ¥é”™:

```typescript
function renameKeys<T extends { [key: string]: unknown }>(
    keysMap: { [key: string]: string },
    obj: T
): T {
    return Object.keys(obj).reduce(
        (acc, key) => ({
            ...acc,
            ...{ [keysMap[key] || key]: obj[key] },
        }),
        {}
    );
}
```

![CleanShot 2021-09-26 at 16.08.22@2x.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc19b8b046224e8d8f6ae1854425f064~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

é—®é¢˜å‡ºåœ¨å‡½æ•°è¿”å›çš„**æ³›å‹ T**.

éšåæˆ‘å°†æ³›å‹ `T` æ”¹ä¸º `{ [key: string]: unknown }` , æŠ¥é”™æ¶ˆå¤±äº†.

```typescript
function renameKeys<T extends { [key: string]: unknown }>(
    keysMap: { [key: string]: string },
    obj: T
): { [key: string]: unknown } {
    return Object.keys(obj).reduce(
        (acc, key) => ({
            ...acc,
            ...{ [keysMap[key] || key]: obj[key] },
        }),
        {}
    );
}
```

è¿™å°±å¾ˆå¥‡æ€ª, `{ [key: string]: unknown }` æœ¬èº«å°±ä¸º `T` çš„çº¦æŸ, ç”¨ `{ [key: string]: unknown }` å’Œç”¨ `T` æœ‰ä»€ä¹ˆåŒºåˆ«å—?

åœ¨æˆ‘ä¸€é¡¿ Google ä¹‹å, åœ¨ä¸€ç¯‡æ–‡ç« ä¸­æ˜ç™½äº†å…¶ä¸­é“ç†.

## ç†è§£ TS æŠ¥é”™ä¿¡æ¯

ä¸‹é¢æˆ‘å°†åˆ†è§£é”™è¯¯æ¶ˆæ¯çš„æ¯å¥è¯:

```text
Type '{}' is not assignable to type 'T'.
  '{}' is assignable to the constraint of type 'T', but 'T' could be instantiated with  a different subtype of constraint '{ [key: string]: unknown; }'
```

### `Type '{}'` ä»€ä¹ˆæ„æ€?

è¿™ä¸ªç±»å‹å¯ä»¥åˆ†é…ä»»ä½•å€¼ï¼Œé™¤äº† `null` æˆ– `undefined`ã€‚ä¾‹å¦‚:

```typescript
type A = {};
const a0: A = undefined; // error
const a1: A = null; // error
const a2: A = 2; // ok
const a3: A = "hello world"; //ok
const a4: A = { foo: "bar" }; //ok
// and so on...
```

### `is not assignable` ä»€ä¹ˆæ„æ€?

åˆ†é…æ˜¯å®ä¾‹ä¸ç±»å‹ç›¸åŒ¹é…ã€‚å¦‚æœä½ çš„å®ä¾‹ä¸åŒ¹é…ç±»å‹ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯ã€‚ä¾‹å¦‚:

```typescript
// type string is not assignable to type number
const a: number = "hello world"; //error

// type number is assinable to type number
const b: number = 2; // ok
```

### `a different subtype` ä»€ä¹ˆæ„æ€?

-   **A æ˜¯ S çš„å­ç±»å‹:** ç±»å‹ A åœ¨ç±»å‹ S çš„åŸºç¡€ä¸Šå¢åŠ äº†é¢å¤–å±æ€§.
-   **A å’Œ B æ˜¯ S çš„ä¸åŒå­ç±»å‹:** ç±»å‹ A ä¸ç±»å‹ B åˆ†åˆ«åœ¨ç±»å‹ S çš„åŸºç¡€ä¸Šå¢åŠ äº†`ä¸åŒçš„`é¢å¤–å±æ€§.

ä¾‹å¦‚: ä¸‹é¢ä»£ç çš„æƒ…å†µæ˜¯

1.  A å’Œ D æ˜¯ç›¸åŒçš„ç±»å‹
2.  B æ˜¯ A çš„å­ç±»å‹
3.  E ä¸æ˜¯ A çš„å­ç±»å‹
4.  B å’Œ C æ˜¯ A çš„ä¸åŒå­ç±»å‹

```typescript
type A = { readonly 0: "0" };
type B = { readonly 0: "0"; readonly foo: "foo" };
type C = { readonly 0: "0"; readonly bar: "bar" };
type D = { readonly 0: "0" };
type E = { readonly 1: "1"; readonly bar: "bar" };
```

```typescript
type A = number;
type B = 2;
type C = 7;
type D = number;
type E = `hello world`;
```

```typescript
type A = boolean;
type B = true;
type C = false;
type D = boolean;
type E = number;
```

> å½“ä½ åœ¨ ts ä¸­ä½¿ç”¨ type å…³é”®å­—æ—¶, ä¾‹å¦‚: `type A = { foo: 'Bar' }`, é‚£ä¹ˆ A æŒ‡å‘çš„æ˜¯è¯¥å€¼çš„ç»“æ„.

### `constraint of typeÂ 'T'` ä»€ä¹ˆæ„æ€?

**ç±»å‹çº¦æŸ**ä»…ä»…æ˜¯ä½ æ”¾åœ¨ `extends` å…³é”®å­—å³ä¾§çš„å†…å®¹ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œç±»å‹çº¦æŸæ˜¯'B'ã€‚

```typescript
const func = <A extends B>(a: A) => `hello!`;
```

æ‰€ä»¥, Type 'B' is theÂ constraint of type 'A'.

### ç±»å‹çº¦æŸ extends

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘å°†å±•ç¤ºä¸‰ç§æƒ…å†µã€‚åœ¨æ¯ç§æƒ…å†µä¸‹å”¯ä¸€ä¼šå˜åŒ–çš„æ˜¯ç±»å‹çº¦æŸï¼Œå…¶ä»–ä»€ä¹ˆéƒ½ä¸ä¼šæ”¹å˜ã€‚

æˆ‘æƒ³è®©ä½ æ³¨æ„çš„æ˜¯ï¼Œç±»å‹çº¦æŸä¸ä¼šé™åˆ¶å…¶å­ç±»å‹ã€‚çœ‹ä»¥ä¸‹ç¤ºä¾‹:

Given:

```typescript
type Foo = { readonly 0: "0" };
type SubType = { readonly 0: "0"; readonly a: "a" };
type DiffSubType = { readonly 0: "0"; readonly b: "b" };
const foo: Foo = { 0: "0" };
const foo_SubType: SubType = { 0: "0", a: "a" };
const foo_DiffSubType: DiffSubType = { 0: "0", b: "b" };
```

CASE 1: æ— ç±»å‹çº¦æŸ

```typescript
const func = <A>(a: A) => `hello!`;

// call examples
const c0 = func(undefined); // ok
const c1 = func(null); // ok
const c2 = func(() => undefined); // ok
const c3 = func(10); // ok
const c4 = func(`hi`); // ok
const c5 = func({}); //ok
const c6 = func(foo); // ok
const c7 = func(foo_SubType); //ok
const c8 = func(foo_DiffSubType); //ok
```

CASE 2: ä¸€èˆ¬çš„ç±»å‹çº¦æŸ

**åœ¨ Typescript ä¸­ï¼Œç±»å‹çº¦æŸä¸ä¼šé™åˆ¶å…¶å­ç±»å‹.**

```typescript
const func = <A extends Foo>(a: A) => `hello!`;

// call examples
const c0 = func(undefined); // error
const c1 = func(null); // error
const c2 = func(() => undefined); // error
const c3 = func(10); // error
const c4 = func(`hi`); // error
const c5 = func({}); // error
const c6 = func(foo); // ok
const c7 = func(foo_SubType); // ok  <-- Allowed
const c8 = func(foo_DiffSubType); // ok <-- Allowed
```

CASE 3: æ›´å…·ä½“çš„çº¦æŸ

```typescript
const func = <A extends SubType>(a: A) => `hello!`;

// call examples
const c0 = func(undefined); // error
const c1 = func(null); // error
const c2 = func(() => undefined); // error
const c3 = func(10); // error
const c4 = func(`hi`); // error
const c5 = func({}); // error
const c6 = func(foo); // error <-- Restricted now
const c7 = func(foo_SubType); // ok  <-- Still allowed
const c8 = func(foo_DiffSubType); // error <-- NO MORE ALLOWED !
```

## æ€»ç»“ç¤ºä¾‹

ä»¥ä¸‹å‡½æ•°:

```typescript
const func = <A extends Foo>(a: A = foo_SubType) => `hello!`; //error!
```

äº§ç”Ÿå¦‚ä¸‹é”™è¯¯ä¿¡æ¯:

```text
Type 'SubType' is not assignable to type 'A'.
  'SubType' is assignable to the constraint of type 'A', but 'A' could be instantiated with a different subtype of constraint 'Foo'.ts(2322)
```

å› ä¸º Typescript æ˜¯ä»`å‡½æ•°è°ƒç”¨ä¸­`æ¨æ–­å‡º Aï¼Œå¹¶ä¸”åœ¨è¯­è¨€ä¸­å¹¶æ²¡æœ‰é™åˆ¶ä½ ç”¨ä¸åŒçš„ 'Foo' å­ç±»å‹æ¥è°ƒç”¨å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„æ‰€æœ‰å‡½æ•°è°ƒç”¨éƒ½è¢«è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„:

```typescript
const c0 = func(foo); // ok! type 'Foo' will be infered and assigned to 'A'
const c1 = func(foo_SubType); // ok! type 'SubType' will be infered
const c2 = func(foo_DiffSubType); // ok! type 'DiffSubType' will be infered
```

**å› æ­¤ï¼Œå°†å…·ä½“ç±»å‹èµ‹å€¼ç»™æ³›å‹ç±»å‹å½¢å‚æ˜¯ä¸æ­£ç¡®çš„ï¼Œå› ä¸ºåœ¨ TS ä¸­ï¼Œç±»å‹å½¢å‚æ€»æ˜¯å¯ä»¥å®ä¾‹åŒ–ä¸ºä»»æ„ä¸åŒçš„å­ç±»å‹ã€‚**

**ç»“è®º: æ°¸è¿œä¸è¦å°†å…·ä½“ç±»å‹èµ‹ç»™æ³›å‹ç±»å‹å‚æ•°ï¼Œå°†å…¶è§†ä¸ºåªè¯»ç±»å‹!**

ç›¸å, è¿™æ ·åš:

```typescript
const func = <A extends Foo>(a: A) => `hello!`; //ok!
```

## ç»“è®º

1.  æ³›å‹æ˜¯å‡½æ•°è¿è¡Œæ—¶æ¨æ–­å‡ºçš„ç±»å‹;
2.  ä¸è¦ç»™æ³›å‹ç±»å‹çš„å½¢å‚è®¾ç½®é»˜è®¤å€¼;
3.  è‹¥éè®¾ç½®é»˜è®¤å€¼ä¸å¯, åªèƒ½æ–­è¨€æ³›å‹ ğŸ˜

## å‚è€ƒ

1.  [How to fix TS2322: â€œcould be instantiated with a different subtype of constraint 'object'â€?](https://www.py4u.net/discuss/1331155 "https://www.py4u.net/discuss/1331155")
2.  [Issue a custom error message when trying to assign constraint type to generic type parameter](https://github.com/Microsoft/TypeScript/issues/29049 "https://github.com/Microsoft/TypeScript/issues/29049")
